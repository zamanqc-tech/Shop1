<!doctype html>
<html lang="bn">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Compact Shop POS — Supplier & Purchase Enabled</title>
<style>
  :root{--bg:#f4f6f8;--card:#fff;--accent:#0ea5a4}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto; margin:0;background:var(--bg);color:#111}
  .wrap{max-width:1100px;margin:14px auto;padding:14px}
  header{display:flex;align-items:center;gap:12px}
  header h1{font-size:18px;margin:0}
  .grid{display:grid;grid-template-columns:1fr 380px;gap:12px;margin-top:12px}
  .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(10,10,10,0.06)}
  input,select,button,textarea{font-size:14px;padding:8px;border-radius:6px;border:1px solid #ddd}
  button{background:var(--accent);color:#fff;border:0;cursor:pointer}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:6px;border-bottom:1px solid #eee;text-align:left}
  .muted{color:#666;font-size:13px}
  .small{font-size:12px}
  .right{text-align:right}
  .khaki{background:#fff8e1}
  .danger{background:#fee2e2}
  .flex{display:flex;gap:8px;align-items:center}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
  .btn-sm{padding:4px 8px;font-size:12px;border-radius:6px}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div style="width:44px;height:44px;border-radius:8px;background:linear-gradient(90deg,#06b6d4,#7c3aed);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">SP</div>
    <div>
      <h1>Compact Shop POS — Supplier & Purchase</h1>
      <div class="muted small">পণ্য, সাপ্লায়ার, ক্রয় (লট), বিক্রি ও রিপোর্ট — লোকাল স্টোরেজ</div>
    </div>
    <div style="margin-left:auto" class="muted small">Ready</div>
  </header>

  <div style="margin-top:12px" class="card">
    <strong>Quick:</strong>
    <button onclick="downloadBackup()" style="margin-left:8px">Backup</button>
    <button onclick="document.getElementById('fileInput').click()" style="margin-left:6px">Restore</button>
    <button onclick="resetAll()" style="margin-left:6px;background:#ef4444">Reset</button>
    <input type="file" id="fileInput" style="display:none" accept=".json" onchange="handleFile(event)"/>
  </div>

  <div class="grid">
    <!-- Left column -->
    <div>
      <!-- Suppliers -->
      <div class="card">
        <h3 style="margin-top:0">সাপ্লায়ার নিবন্ধন</h3>
        <div class="flex">
          <input id="sup_name" placeholder="নাম (Supplier name)" />
          <input id="sup_phone" placeholder="মোবাইল নম্বর" style="width:160px"/>
          <button onclick="addSupplier()">Add Supplier</button>
        </div>
        <div style="margin-top:8px">
          <table>
            <thead><tr><th>নাম</th><th>মোবাইল</th><th>Action</th></tr></thead>
            <tbody id="supplierList"></tbody>
          </table>
        </div>
      </div>

      <!-- Product register -->
      <div class="card" style="margin-top:12px">
        <h3 style="margin-top:0">পণ্য নিবন্ধন</h3>
        <div class="flex">
          <input id="p_name" placeholder="পণ্যের নাম" />
          <input id="p_unit" placeholder="ইউনিট (pcs/kg)" style="width:120px"/>
          <input id="p_price" placeholder="ডিফল্ট সেল প্রাইস" style="width:140px"/>
          <button onclick="registerProduct()">Save</button>
        </div>
        <div class="muted small" style="margin-top:8px">নিবন্ধিত পণ্য</div>
        <table style="margin-top:8px">
          <thead><tr><th>নাম</th><th>ইউনিট</th><th>দাম</th><th></th></tr></thead>
          <tbody id="productList"></tbody>
        </table>
      </div>

      <!-- Purchase from supplier (Buy / Lot) -->
      <div class="card" style="margin-top:12px">
        <h3 style="margin-top:0">সাপ্লায়ার থেকে ক্রয় (লট)</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <select id="buySupplier" style="min-width:180px"><option value="">-- Supplier --</option></select>
          <select id="buyProduct" style="min-width:200px"><option value="">-- Product --</option></select>
          <input id="buyQty" type="number" placeholder="Qty" style="width:100px"/>
          <input id="buyUnitPrice" type="number" placeholder="পাইকারি দাম (per unit)" style="width:160px"/>
          <button onclick="buyFromSupplier()">Buy</button>
        </div>
        <div class="muted small" style="margin-top:8px">পূরাতন ক্রয় (সর্বশেষ 8)</div>
        <div id="purchaseList" style="margin-top:8px"></div>
      </div>

      <!-- Sale / POS -->
      <div class="card" style="margin-top:12px">
        <h3 style="margin-top:0">সেল (POS)</h3>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <input list="prodDatalist" id="saleProduct" placeholder="পণ্য নাম" style="width:240px"/>
          <datalist id="prodDatalist"></datalist>
          <input id="saleQty" type="number" value="1" style="width:80px"/>
          <input id="salePrice" type="number" placeholder="unit price" style="width:120px"/>
          <button onclick="addToCart()">Add</button>
        </div>

        <table style="margin-top:10px">
          <thead><tr><th>পণ্য</th><th>Qty</th><th>Unit</th><th>Subtotal</th><th></th></tr></thead>
          <tbody id="cartT"></tbody>
        </table>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
          <div class="muted">Items: <span id="cartCount">0</span></div>
          <div class="right"><strong>Total: ৳ <span id="cartTotal">0.00</span></strong></div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button onclick="checkout()">Checkout & Save</button>
          <button onclick="printBill()" style="background:#6b7280">Print</button>
          <button onclick="clearCart()" style="background:#ef4444">Clear</button>
        </div>
      </div>

      <!-- Expenses -->
      <div class="card" style="margin-top:12px">
        <h3 style="margin-top:0">দৈনিক খরচ (Expenses)</h3>
        <div class="flex">
          <input id="exp_title" placeholder="বিবরণ (Electric / Rent / Staff)" />
          <input id="exp_amount" type="number" placeholder="Amount" style="width:120px"/>
          <button onclick="addExpense()">Add</button>
        </div>
        <div style="margin-top:8px">
          <table><thead><tr><th>বিবরণ</th><th>টাকা</th><th></th></tr></thead><tbody id="expenseList"></tbody></table>
        </div>
      </div>

    </div>

    <!-- Right column (dashboard & reports) -->
    <div>
      <div class="card">
        <h3 style="margin-top:0">Dashboard</h3>
        <div id="kpis">
          <!-- dynamic KPI boxes -->
        </div>
        <div style="margin-top:8px">
          <b>Top seller this month:</b> <span id="topSeller">-</span><br/>
          <b>Least seller this month:</b> <span id="leastSeller">-</span><br/>
          <b>Most profitable lot:</b> <span id="bestLot">-</span><br/>
          <b>Worst (loss) lot:</b> <span id="worstLot">-</span><br/>
        </div>
        <div style="margin-top:10px">
          <button onclick="showSalesReport()">Recent Sales</button>
          <button onclick="showStockReport()">Stock Report</button>
          <button onclick="showPurchaseReport()">Purchase Report</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px 0">সংক্ষেপ</h4>
        <div class="muted">Products: <strong id="countP">0</strong></div>
        <div class="muted">Suppliers: <strong id="countS">0</strong></div>
        <div class="muted">Stock items: <strong id="countStock">0</strong></div>
        <div class="muted">Sales saved: <strong id="countSales">0</strong></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h4 style="margin:0 0 8px 0">Reports area</h4>
        <div id="reportArea" style="min-height:120px"></div>
      </div>
    </div>
  </div>
</div>

<script>
/* ========= Data structures =========
PRODUCTS: [{id,name,unit,price,lots:[{id,qty,buy, supplierId, date, lotLabel}]}]
SUPPLIERS: [{id,name,phone}]
PURCHASES: [{id,date,supplierId,productId,lotId,qty,unitBuy,total}]
SALES: [{id,date,items:[{productId,qty,unitPrice,lotCost}], total, totalCost, profit}]
EXPENSES: [{id,date,title,amount}]
*/
let PRODUCTS = JSON.parse(localStorage.getItem('pos_products')||'[]');
let SUPPLIERS = JSON.parse(localStorage.getItem('pos_suppliers')||'[]');
let PURCHASES = JSON.parse(localStorage.getItem('pos_purchases')||'[]');
let SALES = JSON.parse(localStorage.getItem('pos_sales')||'[]');
let EXPENSES = JSON.parse(localStorage.getItem('pos_expenses')||'[]');
let CART = [];

function uid(){ return 'id'+Math.random().toString(36).slice(2,9); }
function saveAll(){
  localStorage.setItem('pos_products', JSON.stringify(PRODUCTS));
  localStorage.setItem('pos_suppliers', JSON.stringify(SUPPLIERS));
  localStorage.setItem('pos_purchases', JSON.stringify(PURCHASES));
  localStorage.setItem('pos_sales', JSON.stringify(SALES));
  localStorage.setItem('pos_expenses', JSON.stringify(EXPENSES));
  renderAll();
}
function loadAll(){ // already loaded from top on script load
  renderAll();
}

/* ---------- Supplier functions ---------- */
function addSupplier(){
  const name = document.getElementById('sup_name').value.trim();
  const phone = document.getElementById('sup_phone').value.trim();
  if(!name){ alert('Supplier name লাগবে'); return; }
  SUPPLIERS.push({id:uid(),name,phone});
  document.getElementById('sup_name').value=''; document.getElementById('sup_phone').value='';
  saveAll();
}
function editSupplier(i){
  const s = SUPPLIERS[i];
  const name = prompt('নাম', s.name); if(name===null) return;
  const phone = prompt('মোবাইল নম্বর', s.phone); if(phone===null) return;
  s.name = name; s.phone = phone; saveAll();
}
function deleteSupplier(i){
  if(!confirm('ডিলিট করতে চাও?')) return;
  const id = SUPPLIERS[i].id;
  // also remove references? we keep products but purchases may reference supplier.
  SUPPLIERS.splice(i,1); saveAll();
}

/* ---------- Product functions ---------- */
function registerProduct(){
  const name = document.getElementById('p_name').value.trim();
  const unit = document.getElementById('p_unit').value.trim()||'pcs';
  const price = parseFloat(document.getElementById('p_price').value)||0;
  if(!name){ alert('পণ্যের নাম দিন'); return; }
  if(PRODUCTS.some(p=>p.name.toLowerCase()===name.toLowerCase())){ alert('পণ্য ইতিমধ্যেই আছে'); return; }
  PRODUCTS.push({id:uid(),name,unit,price,lots:[]});
  document.getElementById('p_name').value=''; document.getElementById('p_unit').value=''; document.getElementById('p_price').value='';
  saveAll();
}
function editProduct(i){
  const p = PRODUCTS[i];
  const name = prompt('নাম',p.name); if(name===null) return;
  const price = prompt('সেল প্রাইস', p.price); if(price===null) return;
  p.name = name; p.price = parseFloat(price)||p.price; saveAll();
}
function deleteProduct(i){
  if(!confirm('Product delete?')) return;
  PRODUCTS.splice(i,1); saveAll();
}

/* ---------- Purchase (Buy from supplier) ---------- */
function buyFromSupplier(){
  const supId = document.getElementById('buySupplier').value;
  const prodId = document.getElementById('buyProduct').value;
  const qty = parseFloat(document.getElementById('buyQty').value)||0;
  const unitBuy = parseFloat(document.getElementById('buyUnitPrice').value)||0;
  if(!supId || !prodId || qty<=0 || unitBuy<=0){ alert('সঠিক তথ্য দিন'); return; }
  const product = PRODUCTS.find(p=>p.id===prodId);
  const supplier = SUPPLIERS.find(s=>s.id===supId);
  const lotId = uid();
  const lotLabel = 'L'+Date.now().toString().slice(-6);
  // add lot to product
  product.lots.push({id:lotId, qty:qty, buy:unitBuy, supplierId:supId, date:new Date().toISOString().slice(0,10), lotLabel});
  // record purchase
  PURCHASES.push({id:uid(),date:new Date().toISOString().slice(0,10),supplierId:supId,productId:prodId,lotId,qty,unitBuy,total:qty*unitBuy, lotLabel});
  document.getElementById('buyQty').value=''; document.getElementById('buyUnitPrice').value='';
  saveAll();
}

/* ---------- Sale / POS ---------- */
function addToCart(){
  const name = document.getElementById('saleProduct').value.trim();
  const qty = parseFloat(document.getElementById('saleQty').value)||0;
  let unitPrice = parseFloat(document.getElementById('salePrice').value);
  if(!name || qty<=0){ alert('পণ্য ও পরিমাণ সিলেক্ট করুন'); return; }
  const prod = PRODUCTS.find(p=>p.name.toLowerCase()===name.toLowerCase() || p.id===name);
  if(!prod){ alert('পণ্য নিবন্ধিত নেই'); return; }
  if(isNaN(unitPrice) || unitPrice<=0) unitPrice = prod.price||0;
  // check total stock
  const totalStock = prod.lots.reduce((s,l)=>s+s+l.qty,0); // oops fix: s + l.qty
  // correct reduce:
  const stock = prod.lots.reduce((acc, l)=> acc + l.qty, 0);
  if(qty > stock){ alert('স্টক পর্যাপ্ত নেই — আছে: '+stock); return; }
  CART.push({id:uid(),productId:prod.id, name:prod.name, qty, unitPrice});
  document.getElementById('saleProduct').value=''; document.getElementById('saleQty').value=1; document.getElementById('salePrice').value='';
  renderCart();
}

function renderCart(){
  const tbody = document.getElementById('cartT'); tbody.innerHTML=''; let total=0;
  CART.forEach((c,i)=>{
    const subtotal = c.qty * c.unitPrice;
    total += subtotal;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${c.name}</td><td>${c.qty}</td><td>৳ ${c.unitPrice.toFixed(2)}</td><td>৳ ${subtotal.toFixed(2)}</td>
      <td><button class="btn-sm" onclick="removeCart(${i})" style="background:#ef4444">X</button></td>`;
    tbody.appendChild(tr);
  });
  document.getElementById('cartCount').innerText = CART.length;
  document.getElementById('cartTotal').innerText = total.toFixed(2);
}
function removeCart(i){ CART.splice(i,1); renderCart(); }
function clearCart(){ CART = []; renderCart(); }

/* checkout: reduce stock FIFO by lots and record sale with lot-costs */
function checkout(){
  if(!CART.length){ alert('কার্ট খালি'); return; }
  let saleTotal = 0;
  let totalCost = 0;
  const saleItems = [];
  // for each item, remove from product lots FIFO and compute cost
  for(const item of CART){
    const prod = PRODUCTS.find(p=>p.id===item.productId);
    let need = item.qty;
    const lotsUsed = [];
    // ensure lots are in FIFO by date
    prod.lots.sort((a,b)=> new Date(a.date) - new Date(b.date));
    for(const lot of prod.lots){
      if(need<=0) break;
      if(lot.qty<=0) continue;
      const take = Math.min(need, lot.qty);
      lot.qty -= take;
      need -= take;
      const lotCost = take * lot.buy;
      totalCost += lotCost;
      lotsUsed.push({lotId: lot.id, qty: take, unitBuy: lot.buy, lotLabel: lot.lotLabel});
    }
    // remove empty lots
    prod.lots = prod.lots.filter(l=>l.qty>0);
    const itemTotal = item.qty * item.unitPrice;
    saleTotal += itemTotal;
    saleItems.push({productId: item.productId, name: item.name, qty: item.qty, unitPrice: item.unitPrice, lotsUsed});
  }
  const profit = saleTotal - totalCost;
  const sale = {id:uid(), date:new Date().toISOString().slice(0,10), items: saleItems, total: saleTotal, totalCost, profit};
  SALES.push(sale);
  CART = [];
  saveAll();
  alert('Sale saved. Total: ৳'+saleTotal.toFixed(2)+' | Profit: ৳'+profit.toFixed(2));
}

/* ---------- Expenses ---------- */
function addExpense(){
  const title = document.getElementById('exp_title').value.trim();
  const amount = parseFloat(document.getElementById('exp_amount').value)||0;
  if(!title || amount<=0){ alert('সঠিক তথ্য দিন'); return; }
  EXPENSES.push({id:uid(),date:new Date().toISOString().slice(0,10),title,amount});
  document.getElementById('exp_title').value=''; document.getElementById('exp_amount').value='';
  saveAll();
}

/* ---------- Render / Reports / Dashboard ---------- */
function renderAll(){
  // suppliers
  const supT = document.getElementById('supplierList'); supT.innerHTML='';
  SUPPLIERS.forEach((s,i)=> supT.innerHTML += `<tr><td>${s.name}</td><td>${s.phone||''}</td><td>
    <button class="btn-sm" onclick="editSupplier(${i})">Edit</button>
    <button class="btn-sm" onclick="deleteSupplier(${i})" style="background:#ef4444">Del</button></td></tr>`);
  document.getElementById('buySupplier').innerHTML = '<option value="">-- Supplier --</option>' + SUPPLIERS.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');

  // products
  const pbody = document.getElementById('productList'); pbody.innerHTML='';
  PRODUCTS.forEach((p,i)=> {
    pbody.innerHTML += `<tr><td>${p.name}</td><td>${p.unit}</td><td>৳ ${p.price.toFixed(2)}</td>
      <td><button class="btn-sm" onclick="editProduct(${i})">Edit</button>
      <button class="btn-sm" onclick="deleteProduct(${i})" style="background:#ef4444">Del</button></td></tr>`;
  });
  document.getElementById('prodDatalist').innerHTML = PRODUCTS.map(p=>`<option value="${p.name}">`).join('');
  document.getElementById('buyProduct').innerHTML = '<option value="">-- Product --</option>' + PRODUCTS.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');

  // purchase list
  const pur = document.getElementById('purchaseList'); pur.innerHTML = PURCHASES.slice(-8).reverse().map(p=>{
    const sup = SUPPLIERS.find(s=>s.id===p.supplierId);
    const prod = PRODUCTS.find(x=>x.id===p.productId) || {};
    return `<div style="padding:6px;border-bottom:1px solid #eee">${p.date} — ${prod.name||'—'} — ${p.qty} — ৳ ${p.unitBuy.toFixed(2)} — <small>${sup?sup.name:''}</small></div>`;
  }).join('');

  // expenses
  const expT = document.getElementById('expenseList'); expT.innerHTML='';
  EXPENSES.slice(-8).reverse().forEach((e,i)=> expT.innerHTML += `<tr><td>${e.title}</td><td>৳ ${e.amount.toFixed(2)}</td><td><button class="btn-sm" onclick="deleteExpense(${EXPENSES.length-1-i})" style="background:#ef4444">Del</button></td></tr>`);

  // KPI calculations
  const today = new Date().toISOString().slice(0,10);
  const todaysSales = SALES.filter(s=>s.date===today).reduce((a,b)=>a+b.total,0);
  const todaysProfit = SALES.filter(s=>s.date===today).reduce((a,b)=>a+b.profit,0);
  const todaysExpense = EXPENSES.filter(e=>e.date===today).reduce((a,b)=>a+b.amount,0);
  const monthStart = new Date(); monthStart.setDate(1); const monthStartStr = monthStart.toISOString().slice(0,10);
  const monthSales = SALES.filter(s=>s.date>=monthStartStr).reduce((a,b)=>a+b.total,0);
  const monthProfit = SALES.filter(s=>s.date>=monthStartStr).reduce((a,b)=>a+b.profit,0);

  document.getElementById('kpis').innerHTML = `
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <div style="background:#e6fffa;padding:8px;border-radius:8px">আজকের বিক্রি: ৳ ${todaysSales.toFixed(2)}</div>
      <div style="background:#f0f9ff;padding:8px;border-radius:8px">আজকের লাভ: ৳ ${todaysProfit.toFixed(2)}</div>
      <div style="background:#fff7ed;padding:8px;border-radius:8px">আজকের খরচ: ৳ ${todaysExpense.toFixed(2)}</div>
      <div style="background:#fff1f2;padding:8px;border-radius:8px">মাসিক বিক্রি: ৳ ${monthSales.toFixed(2)}</div>
      <div style="background:#f0fff4;padding:8px;border-radius:8px">মাসিক লাভ: ৳ ${monthProfit.toFixed(2)}</div>
    </div>
  `;

  // top/least seller in month
  const salesInMonth = SALES.filter(s=>s.date>=monthStartStr);
  const productCounts = {};
  salesInMonth.forEach(s=> s.items.forEach(it=> productCounts[it.productId] = (productCounts[it.productId]||0) + it.qty));
  const sorted = Object.entries(productCounts).sort((a,b)=>b[1]-a[1]);
  document.getElementById('topSeller').innerText = sorted.length? (PRODUCTS.find(p=>p.id===sorted[0][0])||{name:'-'}).name : '-';
  document.getElementById('leastSeller').innerText = sorted.length? (PRODUCTS.find(p=>p.id===sorted[sorted.length-1][0])||{name:'-'}).name : '-';

  // best/worst lot by profit across SALES: compute profit per lot via SALES items' lotsUsed
  // We'll construct lotProfits: {lotId: {profit:..., qty:..., productId, lotLabel}}
  const lotProfits = {};
  SALES.forEach(sale=>{
    sale.items.forEach(it=>{
      // sum cost from lotsUsed if present
      if(it.lotsUsed && it.lotsUsed.length){
        it.lotsUsed.forEach(lu=>{
          const revenue = lu.qty * it.unitPrice;
          const cost = lu.qty * lu.unitBuy;
          const profit = revenue - cost;
          if(!lotProfits[lu.lotId]) lotProfits[lu.lotId] = {profit:0, qty:0, productId: it.productId, lotLabel: lu.lotLabel};
          lotProfits[lu.lotId].profit += profit; lotProfits[lu.lotId].qty += lu.qty;
        });
      }
    });
  });
  const lotEntries = Object.entries(lotProfits);
  if(lotEntries.length){
    lotEntries.sort((a,b)=>b[1].profit - a[1].profit);
    const best = lotEntries[0][1]; const worst = lotEntries[lotEntries.length-1][1];
    document.getElementById('bestLot').innerText = `${best.lotLabel} (${(PRODUCTS.find(p=>p.id===best.productId)||{name:'-' }).name}) — ৳ ${best.profit.toFixed(2)}`;
    document.getElementById('worstLot').innerText = `${worst.lotLabel} (${(PRODUCTS.find(p=>p.id===worst.productId)||{name:'-' }).name}) — ৳ ${worst.profit.toFixed(2)}`;
  } else { document.getElementById('bestLot').innerText='-'; document.getElementById('worstLot').innerText='-'; }

  // summary counts
  document.getElementById('countP').innerText = PRODUCTS.length;
  document.getElementById('countS').innerText = SUPPLIERS.length;
  const totalStock = PRODUCTS.reduce((a,b)=> a + b.lots.reduce((x,y)=> x + y.qty,0),0);
  document.getElementById('countStock').innerText = totalStock;
  document.getElementById('countSales').innerText = SALES.length;

  // reports area initial small
  document.getElementById('reportArea').innerHTML = `<div class="muted small">Last sale: ${SALES.length?('৳ '+SALES[SALES.length-1].total.toFixed(2)):'No sales yet'}</div>`;

  // render cart
  renderCart();
}

/* Reports views */
function showSalesReport(){
  const area = document.getElementById('reportArea');
  if(!SALES.length){ area.innerHTML = '<div class="muted">কোনো সেল রেকর্ড নেই</div>'; return; }
  area.innerHTML = SALES.slice(-10).reverse().map(s=>{
    return `<div style="padding:8px;border-bottom:1px solid #eee">
      <b>${s.date}</b> — Total: ৳ ${s.total.toFixed(2)} | Profit: ৳ ${s.profit.toFixed(2)}
      <div style="font-size:13px;margin-top:6px">${s.items.map(it=>`${it.name} x ${it.qty}`).join(' , ')}</div>
    </div>`;
  }).join('');
}
function showStockReport(){
  const area = document.getElementById('reportArea');
  area.innerHTML = PRODUCTS.map(p=>{
    const total = p.lots.reduce((s,l)=>s + l.qty,0);
    return `<div style="padding:6px;border-bottom:1px solid #eee">${p.name} — ${total} ${p.unit} — avg cost: ৳ ${ (total? (p.lots.reduce((acc,l)=> acc + l.qty*l.buy,0)/total):0).toFixed(2) }</div>`;
  }).join('');
}
function showPurchaseReport(){
  const area = document.getElementById('reportArea');
  if(!PURCHASES.length) { area.innerHTML = '<div class="muted">কোনো ক্রয় রেকর্ড নেই</div>'; return; }
  area.innerHTML = PURCHASES.slice(-12).reverse().map(p=>{
    const sup = SUPPLIERS.find(s=>s.id===p.supplierId)||{};
    const prod = PRODUCTS.find(x=>x.id===p.productId)||{};
    return `<div style="padding:6px;border-bottom:1px solid #eee">${p.date} — ${prod.name||''} — ${p.qty} — ৳ ${p.unitBuy.toFixed(2)} — <small>${sup.name||''}</small></div>`;
  }).join('');
}

/* delete expense */
function deleteExpense(i){ if(!confirm('Delete expense?')) return; EXPENSES.splice(i,1); saveAll(); }

/* backup / restore */
function downloadBackup(){
  const data = {PRODUCTS,SUPPLIERS,PURCHASES,SALES,EXPENSES};
  const blob = new Blob([JSON.stringify(data)], {type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'pos_backup.json'; a.click();
}
function handleFile(e){
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload = ()=> {
    try{
      const data = JSON.parse(r.result);
      PRODUCTS = data.PRODUCTS||PRODUCTS;
      SUPPLIERS = data.SUPPLIERS||SUPPLIERS;
      PURCHASES = data.PURCHASES||PURCHASES;
      SALES = data.SALES||SALES;
      EXPENSES = data.EXPENSES||EXPENSES;
      saveAll(); alert('Restore complete');
    }catch(err){ alert('Invalid file'); }
  };
  r.readAsText(f);
}

/* reset */
function resetAll(){ if(!confirm('সব ডেটা মুছে ফেলতে চান?')) return; localStorage.removeItem('pos_products'); localStorage.removeItem('pos_suppliers'); localStorage.removeItem('pos_purchases'); localStorage.removeItem('pos_sales'); localStorage.removeItem('pos_expenses'); PRODUCTS=[]; SUPPLIERS=[]; PURCHASES=[]; SALES=[]; EXPENSES=[]; CART=[]; renderAll(); }

/* print bill */
function printBill(){
  // print last sale or current cart
  let items = [], total=0;
  if(CART.length){ items = CART.map(c=>({name:c.name,qty:c.qty,unit:c.unitPrice, subtotal:c.qty*c.unitPrice})); total = items.reduce((s,it)=>s+it.subtotal,0); }
  else if(SALES.length){ const last = SALES[SALES.length-1]; items = last.items.map(it=>({name:it.name,qty:it.qty,unit:it.unitPrice,subtotal:it.qty*it.unitPrice})); total = last.total; }
  else { alert('No bill to print'); return; }
  const w = window.open('','_blank');
  let html = `<h3>Invoice</h3><table border="1" cellpadding="6" cellspacing="0"><tr><th>Item</th><th>Qty</th><th>Unit</th><th>Subtotal</th></tr>`;
  items.forEach(it=> html += `<tr><td>${it.name}</td><td>${it.qty}</td><td>৳ ${it.unit.toFixed(2)}</td><td>৳ ${it.subtotal.toFixed(2)}</td></tr>`);
  html += `</table><h4>Total: ৳ ${total.toFixed(2)}</h4>`;
  w.document.write(html); w.print();
}

/* init */
renderAll();
</script>
</body>
</html>